name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install root dependencies
        run: npm ci

      - name: Lint vanilla JS
        run: npm run lint

  build:
    name: Build React bundles
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install React dependencies
        working-directory: react
        run: npm install

      - name: TypeScript type check
        working-directory: react
        run: npx tsc --noEmit

      - name: Build React bundles
        working-directory: react
        run: npm run build

      - name: Check bundle sizes
        working-directory: react
        run: |
          echo "Checking bundle sizes (limit: 7168 bytes per bundle)..."
          FAILED=0
          for bundle in ../js/dist/*.js; do
            name=$(basename "$bundle")
            size=$(wc -c < "$bundle")
            kb=$(echo "scale=1; $size / 1024" | bc)
            if [ "$size" -gt 7168 ]; then
              echo "FAIL: $name is ${kb}KB (exceeds 7KB limit)"
              FAILED=1
            else
              echo "OK:   $name is ${kb}KB"
            fi
          done
          if [ "$FAILED" -eq 1 ]; then
            echo "Bundle size check failed. Reduce bundle sizes to stay under 7KB."
            exit 1
          fi
          echo "All bundles within size budget."

      - name: Upload bundles as artifact
        uses: actions/upload-artifact@v4
        with:
          name: react-bundles
          path: js/dist/
          retention-days: 7

  audit:
    name: Security audit
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install root dependencies
        run: npm ci

      - name: Audit root dependencies (devDependencies only - critical level)
        run: npm audit --audit-level=critical || echo "::warning::Root audit found vulnerabilities in dev dependencies (non-production)"

      - name: Install React dependencies
        working-directory: react
        run: npm install

      - name: Audit React dependencies
        working-directory: react
        run: npm audit --audit-level=high

  validate:
    name: Codebase validation
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Check jQuery version consistency
        run: |
          echo "Checking for jQuery version consistency..."
          VERSIONS=$(grep -roh 'jquery/[0-9.]*\|jquery-[0-9.]*\.min' *.html de/*.html fr/*.html legal/*.html 2>/dev/null | grep -oP '[0-9]+\.[0-9]+\.[0-9]+' | sort -u)
          COUNT=$(echo "$VERSIONS" | grep -c '[0-9]' || true)
          echo "jQuery versions found: $VERSIONS"
          if [ "$COUNT" -gt 1 ]; then
            echo "FAIL: Multiple jQuery versions detected"
            exit 1
          fi
          echo "OK: Single jQuery version ($VERSIONS)"

      - name: Check IE shims removed
        run: |
          echo "Checking for IE shims (html5shiv, respond.min.js)..."
          SHIMS=$(grep -rl 'html5shiv\|respond\.min' *.html de/*.html fr/*.html legal/*.html 2>/dev/null || true)
          if [ -n "$SHIMS" ]; then
            echo "FAIL: IE shims still present in:"
            echo "$SHIMS"
            exit 1
          fi
          echo "OK: No IE shims found"

      - name: Check dead legacy JS files removed
        run: |
          echo "Checking for dead legacy JS files..."
          FAILED=0
          for f in js/forms.js js/main.js js/application.js js/npm.js js/utils.js; do
            if [ -f "$f" ]; then
              echo "FAIL: $f should be deleted (zero callers)"
              FAILED=1
            fi
          done
          if [ "$FAILED" -eq 1 ]; then
            exit 1
          fi
          echo "OK: No dead legacy JS files"

      - name: Check data-react mount parity (EN vs DE/FR)
        run: |
          echo "Checking data-react mount parity..."
          EN_MOUNTS=$(grep -o 'data-react="[^"]*"' index.html | sort)
          DE_MOUNTS=$(grep -o 'data-react="[^"]*"' de/index.html 2>/dev/null | sort)
          FR_MOUNTS=$(grep -o 'data-react="[^"]*"' fr/index.html 2>/dev/null | sort)
          EN_COUNT=$(echo "$EN_MOUNTS" | wc -l)
          DE_COUNT=$(echo "$DE_MOUNTS" | wc -l)
          FR_COUNT=$(echo "$FR_MOUNTS" | wc -l)
          echo "EN mounts: $EN_COUNT"
          echo "DE mounts: $DE_COUNT"
          echo "FR mounts: $FR_COUNT"
          if [ "$EN_COUNT" != "$DE_COUNT" ] || [ "$EN_COUNT" != "$FR_COUNT" ]; then
            echo "WARN: Mount count mismatch (EN=$EN_COUNT, DE=$DE_COUNT, FR=$FR_COUNT)"
            echo "EN-only mounts:"
            diff <(echo "$EN_MOUNTS") <(echo "$DE_MOUNTS") || true
          else
            echo "OK: All locales have matching mount counts"
          fi
